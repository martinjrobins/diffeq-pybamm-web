<!DOCTYPE html>
<html>
  <head>
    <title>My webpage</title>
    <script type="module">
      import { Vector, Solver, Options, compileModel, compileResponse } from 'https://unpkg.com/@martinjrobins/diffeq-js@0.0.2/dist/browser.js';
      import "https://cdn.plot.ly/plotly-2.26.0.min.js"
      const text = `
        in = [r, k]
        r { 1 }
        k { 1 }
        u_i {
            y = 1,
            z = 0,
        }
        dudt_i {
            dydt = 0,
            dzdt = 0,
        }
        F_i {
            dydt,
            0,
        }
        G_i {
            (r * y) * (1 - (y / k)),
            (2 * y) - z,
        }
        out_i {
            y,
            z,
        }
      `;
      function linspace(start, stop, num, endpoint = true) {
        const div = endpoint ? (num - 1) : num;
        const step = (stop - start) / div;
        return Array.from({length: num}, (_, i) => start + step * i);
      }
      let times = undefined;
      let timesjs = undefined;
      let inputs = undefined;
      let inputsjs = undefined;
      let min = undefined;
      let max = undefined
      let outputs = undefined;
      let outputsjs = undefined;
      let solver = undefined;
      compileModel(text).then(() => {
        let options = new Options();
        solver = new Solver(options);
        times = new Vector(linspace(0, 10, 100));
        timesjs = times.getFloat64Array();
        inputs = new Vector([1, 2])
        inputsjs = inputs.getFloat64Array();
        min = Array(solver.number_of_inputs).fill(0);
        max = Array(solver.number_of_inputs).fill(1);
        outputs = new Vector(new Array(times.length * solver.number_of_outputs));
        outputsjs = outputs.getFloat64Array();
        initialise();
      });

      function handleRminChange(val) {
        min[0] = val;
        document.getElementById('rminrange').innerHTML = val;
        document.getElementById('rrange').min = val;
      }
      function handleRmaxChange(val) {
        max[0] = val;
        document.getElementById('rmaxrange').innerHTML = val;
        document.getElementById('rrange').max = val;
      }
      function handleRvalueChange(val) {
        inputsjs[0] = val;
        document.getElementById('rrange').value = val;
        handleSolve();
      }
      function handleRrangeChange(val) {
        inputsjs[0] = val;
        document.getElementById('rvalue').value = val;
        handleSolve();
      }
      function handelKminChange(val) {
        min[1] = val;
        document.getElementById('kminrange').innerHTML = val;
        document.getElementById('krange').min = val;
      }
      function handelKmaxChange(val) {
        max[1] = val;
        document.getElementById('kmaxrange').innerHTML = val;
        document.getElementById('krange').max = val;
      }
      function handelKvalueChange(val) {
        inputsjs[1] = val;
        document.getElementById('krange').value = val;
        handleSolve();
      }
      
      function handleKrangeChange(val) {
        inputsjs[1] = val;
        document.getElementById('kvalue').value = val;
        handleSolve();
      }
      function handleSolve() {
        solver.solve(times, inputs, outputs);
        handlePlot();
      }
      function handlePlot() {
        var trace = {
          x: timesjs,
          y: outputsjs.filter((_, i) => i % 2 === 0),
          mode: 'lines',
          type: 'scatter'
        };
        

        var data = [trace];
        var layout = {};
        var options = {}
        Plotly.newPlot('plot', data, layout, options);
      }
      function initialise() {
        if (solver === undefined) {
          return;
        }
        document.getElementById('rmin').value = 0;
        handleRminChange(0);
        document.getElementById('rmax').value = 1;
        handleRmaxChange(1);
        document.getElementById('rvalue').value = 0.5;
        handleRvalueChange(0.5);
        document.getElementById('kmin').value = 0;
        handelKminChange(0);
        document.getElementById('kmax').value = 1;
        handelKmaxChange(1);
        document.getElementById('kvalue').value = 0.5;
        handelKvalueChange(0.5);
        handleSolve();
      }


      window['handleRminChange'] = handleRminChange;
      window['handleRmaxChange'] = handleRmaxChange;
      window['handleRvalueChange'] = handleRvalueChange;
      window['handleKminChange'] = handelKminChange;
      window['handleKmaxChange'] = handelKmaxChange;
      window['handleKvalueChange'] = handelKvalueChange;
      window['handleRrangeChange'] = handleRrangeChange;
      window['handleKrangeChange'] = handleKrangeChange;
      window['handleSolve'] = handleSolve;
      window['inputsjs'] = inputsjs;
      window['outputsjs'] = outputsjs;
      window['timesjs'] = timesjs;
      window['initialise'] = initialise;

    </script>
</head>
<body onload="initialise()">
<h1>Logistic Model</h1>

 
<label for="rmin">Lower Bound:</label>
<input type="number" id="rmin" name="rmin" onchange="handleRminChange(this.value)">
<label for="rvalue">R:</label>
<input type="number" id="rvalue" name="rvalue" onchange="handleRrangeChange(this.value)">
<label for="rmax">Upper Bound:</label>
<input type="number" id="rmax" name="rmax" onchange="handleRmaxChange(this.value)">
<br>
<label for="rrange">R (between <span id='rminrange'></span> and <span id='rmaxrange'></span>):</label>
<input type="range" id="rrange" name="rrange" min="0" max="1" step="0.1" oninput="handleRrangeChange(this.value)" on>

<br><br>

<label for="kmin">Lower Bound:</label>
<input type="number" id="kmin" name="kmin" onchange="handleKminChange(this.value)">
<label for="kvalue">K:</label>
<input type="number" id="kvalue" name="kvalue" onchange="handleKrangeChange(this.value)">
<label for="kmax">Upper Bound:</label>
<input type="number" id="kmax" name="kmax" onchange="handleKmaxChange(this.value)">
<br>
<label for="krange">K (between <span id='kminrange'></span> and <span id='kmaxrange'></span>):</label>
<input type="range" id="krange" name="krange" min="0" max="1" step="0.1" oninput="handleKrangeChange(this.value)">


<br><br>
<div id="plot" style="width:800px;height:500px;"></div>

</body>
</html>